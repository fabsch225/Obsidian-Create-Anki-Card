"use strict";var d=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var y=(n,r)=>{for(var e in r)d(n,e,{get:r[e],enumerable:!0})},S=(n,r,e,i)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of w(r))!v.call(n,t)&&t!==e&&d(n,t,{get:()=>r[t],enumerable:!(i=f(r,t))||i.enumerable});return n};var _=n=>S(d({},"__esModule",{value:!0}),n);var $={};y($,{DEFAULT_SETTINGS:()=>C,default:()=>g});module.exports=_($);var k=require("obsidian");var a=require("obsidian");var N="http://127.0.0.1:8765";async function p(n,r={}){let i=await(await fetch(N,{method:"POST",body:JSON.stringify({action:n,version:6,params:r})})).json();if(i.error)throw new Error(i.error);return i.result}async function h(){return p("deckNames")}async function u(n,r,e){return p("addNote",{note:{deckName:n,modelName:"Basic",fields:{Front:r,Back:e},tags:["obsidian"]}})}function m(n,r,e){let i=[];return e&&(n=n.replace(/```[\s\S]*?```/g,t=>(i.push(t),`__CODE_BLOCK_${i.length-1}__`))),r&&(n=n.replace(/\$\$([\s\S]+?)\$\$/g,(t,s)=>`\\[${s.trim()}\\]`),n=n.replace(/(?<!\$)\$(?!\$)(.+?)(?<!\$)\$(?!\$)/g,(t,s)=>`\\(${s.trim()}\\)`)),e&&i.forEach((t,s)=>{n=n.replace(`__CODE_BLOCK_${s}__`,t)}),n}var l=class extends a.Modal{constructor(e,i,t){super(e);this.plugin=i;this.selectedText=t;this.deck="";this.title=""}async onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Create Anki Card"});let i=await this.plugin.getFirstHeadingFromSelection(this.selectedText);this.title=i??"",new a.Setting(e).setName("Front (Title)").addText(t=>{t.onChange(s=>{this.title=s}),t.setValue(this.title)});try{let t=await h();new a.Setting(e).setName("Deck").addDropdown(s=>{t.forEach(c=>s.addOption(c,c));let o=this.plugin.settings.defaultDeck||t[0];this.deck=o,s.setValue(o),s.onChange(async c=>{this.deck=c,this.plugin.settings.defaultDeck=c,await this.plugin.saveSettings()})}),new a.Setting(e).setName("Convert Math ($ \u2192 \\()").addToggle(s=>s.setValue(this.plugin.settings.convertMath).onChange(async o=>{this.plugin.settings.convertMath=o,await this.plugin.saveSettings()})),new a.Setting(e).setName("Preserve Code Blocks").addToggle(s=>s.setValue(this.plugin.settings.preserveCodeBlocks).onChange(async o=>{this.plugin.settings.preserveCodeBlocks=o,await this.plugin.saveSettings()}))}catch{new a.Notice("Could not connect to Anki. Is Anki running?"),this.close();return}new a.Setting(e).addButton(t=>t.setButtonText("Create Card").setCta().onClick(async()=>{if(!this.title){new a.Notice("Front cannot be empty.");return}try{let s=m(this.selectedText,this.plugin.settings.convertMath,this.plugin.settings.preserveCodeBlocks);await u(this.deck,this.title,s),new a.Notice("Card created successfully!"),this.close()}catch{new a.Notice("Failed to create card.")}}))}onClose(){this.contentEl.empty()}};var C={defaultDeck:"",convertMath:!0,preserveCodeBlocks:!0},g=class extends k.Plugin{constructor(){super(...arguments);this.settings={defaultDeck:"",convertMath:!0,preserveCodeBlocks:!0}}getFirstHeadingFromSelection(e){let i=e.split(`
`);console.log(i);for(let t of i){let o=t.trim().match(/^#{1,6}\s+(.*)$/);if(o)return o[1].trim()}return null}async onload(){await this.loadSettings(),this.app.workspace.onLayoutReady(()=>{this.registerEvent(this.app.workspace.on("editor-menu",(e,i)=>{let t=i.getSelection();t&&t.trim().length>0&&e.addItem(s=>{s.setTitle("Create Anki Card").setIcon("plus-circle").onClick(()=>{new l(this.app,this,t).open()})})}))})}async loadSettings(){this.settings=Object.assign({},C,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}onunload(){}};
